name: Deploy AWS Lambda

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read
  pages: write

concurrency:
  group: github-pages
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      ContinuousIntegrationEnv: true
    environment:
      name: github-pages
      url: ${{ steps.deploy_pages.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          role-to-assume: arn:aws:iam::481665083094:role/hrabot-deploy
          aws-region: us-east-1

      - name: Install Lambda Tools
        run: dotnet tool install -g Amazon.Lambda.Tools

      - name: Generate api clients
        run: |
          chmod +x scripts/client-gen.sh
          ./scripts/client-gen.sh

      - name: Restore and Build
        run: dotnet build -c Release

      - name: Install playwright deps
        run: npx playwright install --with-deps --only-shell chromium

      - name: Trust https certs
        run: dotnet dev-certs https --trust

      - name: Test
        run: dotnet test -c Release --no-build

      - name: Deploy Lambda
        working-directory: src/HraBot.Core
        run: |
          dotnet lambda deploy-serverless \
            --stack-name MyLambdaStack \
            --s3-bucket hra-bot-lambdas \
            --region us-east-2 \
            --template serverless.template

      - name: Build frontend
        working-directory: src/hrabot-web
        env:
          VITE_API_ENDPOINT: https://glxyrc58i4.execute-api.us-east-2.amazonaws.com
          VITE_BASE: /HraBot/
        run: npm run build

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: src/hrabot-web/dist

      - name: Deploy to GitHub Pages
        id: deploy_pages
        uses: actions/deploy-pages@v4

  # deploy_frontend:
  #   name: Deploy Frontend
  #   runs-on: ubuntu-latest
  #   needs: deploy
  #   environment:
  #     name: github-pages
  #     url: ${{ steps.deploy_pages.outputs.page_url }}

  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4

  #     - name: Setup Node
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: "22"
  #         cache: "npm"
  #         cache-dependency-path: src/hrabot-web/package-lock.json

  #     - name: Install dependencies
  #       working-directory: src/hrabot-web
  #       run: npm ci

  #     - name: Build frontend
  #       working-directory: src/hrabot-web
  #       run: npm run build

  #     - name: Upload Pages artifact
  #       uses: actions/upload-pages-artifact@v3
  #       with:
  #         path: src/hrabot-web/dist

  #     - name: Deploy to GitHub Pages
  #       id: deploy_pages
  #       uses: actions/deploy-pages@v4
